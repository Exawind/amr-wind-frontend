# Tutorial 2: Setting up an LES ABL calculation

<!-- NOTE: The tutorial is actually generated by make_tutorial2setup.py -->

<!--INTROTEXTSETUP-->
## Introduction

This tutorial will demonstrate the following features: 
- How to use `amrwind-frontend` to set up an LES ABL case.

### Background

The desired conditions for this ABL case are derived from the IEA29
REF1 conditions measured off of the coast of Denmark.  

| Parameter                 | Value       |
| ---                       | ---         |
| Turbine hub height        | 57.19 m     |
| Hub height wind speed     | 6.1 m/s     |
| Hub height wind direction | 230 degrees |
| Hub height TI             | 0.068       |
| Hub height shear exponent | 0.0025      |
<!--INTROTEXTEND-->

## Simulation settings

In the **Simulation** tab, go to the **Simulation type** window, and 
choose `['ABL']` for **Physics models**.

Then under the **Time control** section, set the following parameters:

| Parameter  | Value            |
| ---        | ---              |
| Max time   | 20000.0 |
| Max steps  | 40000  |
| March with | `const dt` |
| dt         | 0.5  |

Under **Restart parameters**, set **Check file** to `chk`.
Then the settings at the top of the tab should look like:  

![images/time_settings.png](images/time_settings.png)

Now in the **Fluid and transport properties** section, set the
following:

| Parameter         | Value                 |
| ---               | ---                   |
| Dynamic viscosity | 1.8375e-05 |

In the **Godunov parameters** section and the **Turbulence
parameters** section, set the following parameters:

| Parameter        | Value                 |
| ---              | ---                   |
| Use godunov      | True  |
| Godunov type     | weno |
| Turbulence model | ['OneEqKsgsM84']    |
| TKE source terms | ['KsgsM84Src']    |

After setting these variables, the bottom part of the tab should look
like:

![images/turb_settings.png](images/turb_settings.png)

## Domain and boundary conditions

In the **Domain** tab, we'll set the computational domain and boundary
conditions.

| Parameter       | Value              | Comment                               |
| ---             | ---                | ---                                   |
| Domain corner 1 | [0.0, 0.0, 0.0] |                                       |
| Domain corner 2 | [1536.0, 1536.0, 1920.0] |                                       |
| Mesh size       | [128, 128, 160]       | Number of cells in X, Y, Z directions |
| Periodic in X   | True     |                                       |
| Periodic in Y   | True     |                                       |
| Periodic in Z   | False     | Z is not periodic                     |


![images/domain_settings.png](images/domain_settings.png)

Now we'll set the boundary conditions on the upper and lower Z
surfaces. Press **[show]** next to **Boundary conditions on Z faces**,
then use these parameter values in the following fields, and you can
leave the remainder of them blank.

| Parameter       | Value                  | Comment                          |
| ---             | ---                    | ---                              |
| zlo velocity BC | wall_model             |                                  |
| zlo temp BC     | wall_model |                                  |
| zlo TKE BC      | zero_gradient         |                                  |
| zhi velocity BC | slip_wall             |                                  |
| zhi temp BC     | fixed_gradient |                                  |
| zhi temperature | 0.000974025974      | This is actually the dT/dz value |


It should look like this in the front-end interface:
	
![images/zBC_settings.png](images/zBC_settings.png)

## ABL settings

In the **ABL** tab, we'll add the necessary physical values for an ABL
simulation.  First in the **ABL Forcing** window, check the following
items:

| Parameter              | Value               |
| ---                    | ---                 |
| add ABL Forcing        | True        |
| add Coriolis forces    | True   |
| add Boussinesq forcing | True |

Next we'll set the ABL wind speed and direction.  In the **ABL
physics** section, use the following variables:

| Parameter      | Value                           |
| ---            | ---                             |
| Wind speed     | 6.13                 |
| Wind direction | 230.07                   |
| Forcing height | 57.19 |

 Then hit the **[Calc W. Vec]** button, and it should automatically
 calculate the correct wind vector to use.

![images/ABL_settings1.png](images/ABL_settings1.png)

![images/ABL_settings2.png](images/ABL_settings2.png)

## IO settings

![images/IO_settings.png](images/IO_settings.png)

![images/phub_settings1.png](images/phub_settings1.png)

![images/phub_settings2.png](images/phub_settings2.png)

![images/xbc_settings1.png](images/xbc_settings1.png)

![images/xbc_settings2.png](images/xbc_settings2.png)

![images/ybc_settings1.png](images/ybc_settings1.png)

![images/ybc_settings2.png](images/ybc_settings2.png)

## Expert settings

| Parameter                     | Value                           |
| ---                           | ---                             |
| nodal_proj.mg_rtol            | 1e-06            |
| nodal_proj.mg_atol            | 1e-12            |
| mac_proj.mg_rtol              | 1e-06              |
| mac_proj.mg_atol              | 1e-12              |
| diffusion.mg_rtol             | 1e-06             |
| diffusion.mg_atol             | 1e-12             |
| temperature_diffusion.mg_rtol | 1e-10 |
| temperature_diffusion.mg_atol | 1e-13 |

![images/expert_settings.png](images/expert_settings.png)

## Plot of the domain

![images/plotDomainWin_samplingzone.png](images/plotDomainWin_samplingzone.png)

![images/plotDomainFig_sampling.png](images/plotDomainFig_sampling.png)

## Writing the input file

To see what the AMR-Wind input file would look like, you can go to the
menu bar, select **Run** --> **Preview Input File**, to see the
preview window (you can also just hit **File** --> **Save input file
as** to save it to a file).

<details>
  <summary>[input file]</summary>
<pre>
# --- Simulation time control parameters ---
time.stop_time                           = 20000.0             # Max (simulated) time to evolve [s]
time.max_step                            = 40000               
time.fixed_dt                            = 0.5                 # Fixed timestep size (in seconds). If negative, then time.cfl is used
time.checkpoint_interval                 = 2000                
incflo.physics                           = ABL                 # List of physics models to include in simulation.
incflo.verbose                           = 3                   
io.check_file                            = chk                 
incflo.use_godunov                       = true                
incflo.godunov_type                      = weno                
turbulence.model                         = OneEqKsgsM84        
TKE.source_terms                         = KsgsM84Src          
nodal_proj.mg_rtol                       = 1e-06               
nodal_proj.mg_atol                       = 1e-12               
mac_proj.mg_rtol                         = 1e-06               
mac_proj.mg_atol                         = 1e-12               
diffusion.mg_rtol                        = 1e-06               
diffusion.mg_atol                        = 1e-12               
temperature_diffusion.mg_rtol            = 1e-10               
temperature_diffusion.mg_atol            = 1e-13               
incflo.gravity                           = 0.0 0.0 -9.81       # Gravitational acceleration vector (x,y,z) [m/s^2]
incflo.density                           = 1.0                 # Fluid density [kg/m^3]
transport.viscosity                      = 1.8375e-05          # Fluid dynamic viscosity [kg/m-s]
transport.laminar_prandtl                = 0.7                 # Laminar prandtl number
transport.turbulent_prandtl              = 0.3333              # Turbulent prandtl number
# --- Geometry and Mesh ---
geometry.prob_lo                         = 0.0 0.0 0.0         
geometry.prob_hi                         = 1536.0 1536.0 1920.0
amr.n_cell                               = 128 128 160         # Number of cells in x, y, and z directions
amr.max_level                            = 0                   
geometry.is_periodic                     = 1 1 0               
zlo.type                                 = wall_model          
zlo.temperature_type                     = wall_model          
zlo.tke_type                             = zero_gradient       
zhi.type                                 = slip_wall           
zhi.temperature_type                     = fixed_gradient      
zhi.temperature                          = 0.000974025974      
# --- ABL parameters ---
ICNS.source_terms                        = ABLForcing BoussinesqBuoyancy CoriolisForcing 
ABL.stats_output_frequency               = 1                   
ABL.stats_output_format                  = netcdf              
incflo.velocity                          = 4.70066290054 3.93454804209 0.0
ABLForcing.abl_forcing_height            = 57.19               
ABL.kappa                                = 0.4                 
ABL.normal_direction                     = 2                   
ABL.surface_roughness_z0                 = 0.0001              
ABL.reference_temperature                = 288.15              
ABL.surface_temp_rate                    = 0.0                 
ABL.surface_temp_flux                    = 0.0122096146646     # Surface temperature flux [K-m/s]
ABL.mo_beta_m                            = 16.0                # Monin-Obukhov Beta m parameter
ABL.mo_gamma_m                           = 5.0                 # Monin-Obukhov Gamma m parameter
ABL.mo_gamma_h                           = 5.0                 # Monin-Obukhov Gamma h parameter
ABL.random_gauss_mean                    = 0.0                 
ABL.random_gauss_var                     = 1.0                 
CoriolisForcing.latitude                 = 55.49               
CoriolisForcing.rotational_time_period   = 86164.0900027       
CoriolisForcing.north_vector             = 0.0 1.0 0.0         
CoriolisForcing.east_vector              = 1.0 0.0 0.0         
BoussinesqBuoyancy.reference_temperature = 288.15              
ABL.temperature_heights                  = 1050.0 1150.0 1920.0
ABL.temperature_values                   = 288.15 296.15 296.9 
ABL.perturb_velocity                     = false               
ABL.perturb_temperature                  = false               
time.plot_interval                       = 2000                
io.plot_file                             = plt                 
io.KE_int                                = -1                  
incflo.post_processing                   = sampling            
# --- Sampling parameters ---
sampling.output_frequency                = 100                 
sampling.fields                          = velocity temperature
#---- sample defs ----
sampling.labels                          = p_hub xbc ybc       
sampling.p_hub.type                      = PlaneSampler        
sampling.p_hub.num_points                = 129 129             
sampling.p_hub.origin                    = 0.0 0.0 0.0         
sampling.p_hub.axis1                     = 1536.0 0.0 0.0      
sampling.p_hub.axis2                     = 0.0 1536.0 0.0      
sampling.p_hub.normal                    = 0.0 0.0 1.0         
sampling.p_hub.offsets                   = 17        28.5      41        57        77        90
sampling.xbc.type                        = PlaneSampler        
sampling.xbc.num_points                  = 257 161             
sampling.xbc.origin                      = 0.0 0.0 0.0         
sampling.xbc.axis1                       = 0.0 1536.0 0.0      
sampling.xbc.axis2                       = 0.0 0.0 1920.0      
sampling.xbc.normal                      = 1.0 0.0 0.0         
sampling.xbc.offsets                     = 0.0 1536            
sampling.ybc.type                        = PlaneSampler        
sampling.ybc.num_points                  = 257 161             
sampling.ybc.origin                      = 0.0 0.0 0.0         
sampling.ybc.axis1                       = 1536.0 0.0 0.0      
sampling.ybc.axis2                       = 0.0 0.0 1920.0      
sampling.ybc.normal                      = 0.0 1.0 0.0         
sampling.ybc.offsets                     = 0.0 1536            
#---- extra params ----
#== END AMR-WIND INPUT ==
</pre>
</details>

